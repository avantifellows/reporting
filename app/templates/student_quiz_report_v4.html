{% extends "layout.html" %}
{% block title %}Index{% endblock %}
{% block content %}
<div id="name_card">
  {% if report_data["student_name"] != "" %}
    <p>Name: {{report_data["student_name"]}}
  {% endif %}
  <p>Student ID: {{report_data["student_id"]}}
</div>
<div id="test_summary_card">
  <div class="percentage"> {{report_data["percentage"]}}%</div>
  <div class="test_details">
    <div>{{report_data["test_name"]}}</div>
    <div>{{report_data["test_date"]}}</div>
  </div>
</div>

<!-- New message section -->
<div id="message_section">
  <p class="message">{{report_data["message_part_1"]}}</p>
  <p class="message">{{report_data["message_part_2"]}}</p>

  <div class="buttons_container">
    {% if "revision_chapter_link" in report_data and report_data["revision_chapter_link"] != "" %}
      <div class="button_wrapper">
        <a class="answer_sheet_button" target="_blank" data-track-button="revise_chapter" href={{report_data['revision_chapter_link']}}>
          Revise Chapter
        </a>
      </div>
    {% endif %}

    {% if "test_link" in report_data %}
      <div class="button_wrapper">
        <a class="answer_sheet_button" target="_blank" data-track-button="review_quiz" href={{report_data['test_link']}}>
          Review Quiz
        </a>
        <span class="help_text">Check out answer key & solutions</span>
      </div>
    {% endif %}

    <!-- Predict Button - NEW in v4 -->
    <div class="button_wrapper">
      <button class="answer_sheet_button" id="predictButton" onclick="openPredictionModal()">
        Predict
      </button>
      <span class="help_text">View marks to percentile prediction</span>
    </div>
  </div>
</div>

<section id="overall_performance">
  <div id="section_heading">Overall Performance</div>
  {% set score_details = report_data["overall_performance"] %}
  <table id="score_details">
    {% for key, value in score_details["table_data"].items() if key not in ["Partially Correct", "Topper Marks", "Percentile", "Rank"] %}
      <tr>
        <td>{{key}}</td>
        <td>{{value}}</td>
      </tr>
    {% endfor %}
  </table>
</section>

<section id="subject_peformance">
  {% set section_reports = report_data["section_reports"] %}
  {% for section_report in section_reports %}
    <div id="section_heading">{{ section_report["name"] }}</div>
    <table id="score_details">
      {% for key, value in section_report["table_data"].items() if key not in ["chapter_level_data", "Partially Correct", "Topper Marks", "Percentile", "Rank"]  %}
        <tr>
          <td>{{key}}</td>
          <td>{{value}}</td>
        </tr>
      {% endfor %}
      {% if "chapter_level_data" in section_report["table_data"] %}
        <table id="chapter_details">
          <tr>
            <td>Chapter</td>
            <td>Score</td>
            <td>Accuracy</td>
            <td>Attempt Rate</td>
            <td>Priority</td>
          </tr>
          <div id="chapter_wise_heading">Chapterwise Performance</div>
          {% for row in section_report["table_data"]["chapter_level_data"] %}
            <tr>
              <td>{{ row["chapter_name"] }}</td>
              <td>{{ row["marks_scored"] }}</td>
              <td>{{ row["accuracy"] }} </td>
              <td>{{ row["attempt_percentage"] }}</td>
              <td>{{ row["priority"] }}</td>
            </tr>
          {% endfor %}
        </table>
      {% endif %}
    </table>
  {% endfor %}
</section>

<!-- Prediction Modal - NEW in v4 -->
<div id="predictionModal" class="modal" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h2>JEE Main Prediction</h2>
      <span class="close" onclick="closePredictionModal()">&times;</span>
    </div>

    <div class="modal-body">
      <div class="prediction-info">
        <p>Predicting for <strong>{{report_data["overall_performance"]["table_data"]["Marks"]}}</strong> marks with <strong>General</strong> category</p>
      </div>

      <div id="predictionLoader" class="loader" style="display: none;">
        <div class="spinner"></div>
        <p>Getting your prediction...</p>
      </div>

      <div id="predictionResults" class="results-section" style="display: none;">
        <div class="results-grid">
          <div class="result-card">
            <div class="result-value" id="resultMarks">-</div>
            <div class="result-label">Marks (/300)</div>
          </div>

          <div class="result-card">
            <div class="result-value" id="resultPercentile">-</div>
            <div class="result-label">Percentile</div>
          </div>

          <div class="result-card">
            <div class="result-value" id="resultAllIndiaRank">-</div>
            <div class="result-label">All India Rank</div>
          </div>

          <div class="result-card">
            <div class="result-value" id="resultCategoryRank">-</div>
            <div class="result-label">GEN Rank</div>
          </div>
        </div>

        <div class="status-badge" id="statusBadge">
          <i class="fas fa-check-circle"></i>
          Prediction Complete
        </div>

        <div style="text-align: center; margin-top: 20px;">
          <button id="viewCollegesBtn" onclick="openCollegePredictor()"
                  style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; color: white; cursor: pointer; transition: all 0.3s ease;">
            <i class="fas fa-university"></i> View Colleges
          </button>
        </div>
      </div>

      <div id="predictionError" class="error-section" style="display: none;">
        <p>Unable to get prediction. Please try again later.</p>
      </div>
    </div>
  </div>
</div>

<style>
  .message {
    margin: 15px 0;
    font-size: 16pt;
    text-align: center;
  }

  .buttons_container {
    display: flex;
    justify-content: center;
    align-items: flex-start; /* Align tops of button wrappers */
    gap: 20px;
    margin: 25px 0;
  }

  .button_wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .help_text {
    color: #888;
    font-size: 12px;
    margin-top: 5px;
  }

  /* Make answer_sheet_button a class instead of an ID */
  .answer_sheet_button {
    display: table;
    text-align: center;
    font-size: 18pt;
    background-color: #29973E;
    border-radius: 3px;
    text-decoration: none;
    color: white;
    padding: 10px 40px 10px 40px;
    box-shadow: 1px 1px 5px #535353;
    border: none;
    cursor: pointer;
  }

  /* Prevent underline and color change on hover */
  .answer_sheet_button:hover {
    text-decoration: none;
    color: white;
  }

  /* Modal Styles - NEW in v4 */
  .modal {
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .modal-content {
    background-color: white;
    border-radius: 10px;
    width: 90%;
    max-width: 600px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid #eee;
  }

  .modal-header h2 {
    margin: 0;
    color: #333;
  }

  .close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
  }

  .close:hover {
    color: black;
  }

  .modal-body {
    padding: 20px;
  }

  .prediction-info {
    text-align: center;
    margin-bottom: 20px;
    font-size: 16px;
    color: #666;
  }

  .loader {
    text-align: center;
    padding: 40px;
  }

  .spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #29973E;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 0 auto 20px;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .results-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
  }

  .result-card {
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    border-radius: 10px;
    padding: 20px;
    text-align: center;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  }

  .result-value {
    font-size: 24px;
    font-weight: bold;
    color: #333;
    margin-bottom: 5px;
  }

  .result-label {
    font-size: 14px;
    color: #666;
  }

  .status-badge {
    background: linear-gradient(135deg, #29973E 0%, #22803c 100%);
    color: white;
    padding: 15px;
    border-radius: 10px;
    text-align: center;
    margin-bottom: 20px;
    font-weight: 600;
  }

  .error-section {
    text-align: center;
    color: #d32f2f;
    padding: 20px;
  }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
<script>
let currentPrediction = null;

async function openPredictionModal() {
    const modal = document.getElementById('predictionModal');
    const loader = document.getElementById('predictionLoader');
    const results = document.getElementById('predictionResults');
    const error = document.getElementById('predictionError');

    // Show modal
    modal.style.display = 'flex';

    // Reset states
    loader.style.display = 'none';
    results.style.display = 'none';
    error.style.display = 'none';

    // Get marks from the page data
    const marks = parseInt('{{report_data["overall_performance"]["table_data"]["Marks"]}}');

    // Show loader and start prediction
    loader.style.display = 'block';

    try {
        const response = await fetch('http://localhost:3001/api/predict', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                marks: marks,
                category: 'GEN'
            })
        });

        if (!response.ok) {
            throw new Error('Prediction failed');
        }

        const result = await response.json();

        if (!result.success) {
            throw new Error('Prediction failed');
        }

        currentPrediction = result;
        displayPredictionResults(result.prediction);

    } catch (err) {
        console.error('Prediction error:', err);
        loader.style.display = 'none';
        error.style.display = 'block';
    }
}

function displayPredictionResults(prediction) {
    const loader = document.getElementById('predictionLoader');
    const results = document.getElementById('predictionResults');

    // Hide loader
    loader.style.display = 'none';

    // Update result values
    document.getElementById('resultMarks').textContent = prediction.marksOutOf300;
    document.getElementById('resultPercentile').textContent = `${prediction.percentile.toFixed(3)}%`;
    document.getElementById('resultAllIndiaRank').textContent = formatNumber(prediction.air);
    document.getElementById('resultCategoryRank').textContent = formatNumber(prediction.categoryRank);

    // Show results
    results.style.display = 'block';
}

function formatNumber(num) {
    return num.toLocaleString('en-IN');
}

function openCollegePredictor() {
    if (!currentPrediction) return;

    const prediction = currentPrediction.prediction;
    const baseUrl = 'http://localhost:3001'; // You can make this environment-based later

    const params = new URLSearchParams({
        exam: 'JoSAA',
        rank: prediction.air,
        code: 'JoSAA',
        category: 'OPEN', // GEN maps to OPEN
        gender: 'Gender-Neutral',
        program: 'Engineering',
        homeState: 'Delhi',
        preferHomeState: 'Yes',
        qualifiedJeeAdv: 'No',
        mainRank: prediction.air
    });

    const url = `${baseUrl}/college_predictor?${params.toString()}`;
    window.open(url, '_blank');
}

function closePredictionModal() {
    document.getElementById('predictionModal').style.display = 'none';
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('predictionModal');
    if (event.target === modal) {
        closePredictionModal();
    }
}
</script>
{% endblock %}
